<html>
<head>
  <title>.osu to .chart, but why</title>
</head>
<body>
<script>
const MIN_MULT = 0.0001;
// Most likely mp3 overhead idk
var DUMB_OFFSET = 0;

let precision = 12;
const convert = source => {
  const lines = source.split("\n");
  const timingPointsIndex = lines.findIndex(line => line.includes("[TimingPoints]"));
  const hitObjectsIndex = lines.findIndex(line => line.includes("[HitObjects]"));

  const bpms = [];
  const svs = [];
  lines.slice(timingPointsIndex, hitObjectsIndex).forEach(line => {
    const [ms, value] = line.split(',');
    if (value == null) return;
    if (value < 0) {
      svs.push({ value: Math.round(10000 / (-value)) / 100, ms: +ms });
    } else {
      if (bpms.length < 1) bpms.push({ bpm: Math.round(60000 / (+value)), ms: +ms });
    }
  });

  // Hypothetically, .osu "indexes" are their positions in milliseconds (arguably terrible)
  // The cheap strategy (for now) is to go by PRECISION, compute time and grab the ones that match

  // Notes:
  // 64 = 1, 192 = 2, 320 = 3, 448 = 4

  // in the last x:x:x:x:x: group, the first number is the timestamp where the sustain should stop
  const osuNotes = {};
  lines.slice(hitObjectsIndex).forEach(line => {
    const [noteId,, time,,, rest] = line.split(",");
    if (!time) return;
    const [end] = rest.split(':');
    if (!osuNotes[time]) osuNotes[time] = [];
    osuNotes[time].push({
      note: {
        64: 1,
        192: 2,
        320: 3,
        448: 4
      }[noteId] || 2,
      end: +end || undefined
    });
  });

  const times = Object.keys(osuNotes).sort((a, b) => Number(a) - Number(b));
  const synctrack = [];
  const notes = [];
  let time = bpms[0].ms;
  // Skip the first measure, assume the constant BPM from there
  // "24" is the 1/32 interval
  let bpm = bpms[0].bpm;
  for (let index = 384; times.length || bpms.length || svs.length; index += precision) {
    if (times.length && time >= times[0]) {
      notes.push(
        ...osuNotes[times.shift()]
          .map(({ note, end }) => ({
            index,
            note,
            end,
            length: 0
          }))
      );
    }

    notes.forEach(note => {
      if (note.end && time < note.end) {
        note.length += precision;
      }
    });

    if (bpms.length && time >= bpms[0].ms) {
      bpm = bpms.shift().bpm;
      synctrack.push({ index, bpm });
    }

    if (svs.length && time >= svs[0].ms) {
      notes.push({ index, event: `sv:${svs.shift().value}` });
    }


    // time += <index delta> * 60 / (bpm * resolution)... but that's in seconds, so *1000
    time += (precision * 60000) / (bpm * 192);
  }

  let txt = `[Song]
{
  Offset = 0
  Resolution = 192
  Player2 = bass
  Difficulty = 0
  PreviewStart = 0
  PreviewEnd = 0
  Genre = "rock"
  MediaType = "cd"
  MusicStream = "audio.mp3"
}
[SyncTrack]
{
  0 = TS 2
  0 = B 165671
  384 = TS 4
  ${synctrack.map(({ index, bpm }) => `  ${index} = B ${bpm*1000}`).join('\n')}
}
[Events]
{
}  
[ExpertDrums]
{
`;
  txt += notes.map(({ note, index, event, length }) => event ? `  ${index} = E ${event}` : `  ${index} = N ${note} ${length}`).join("\n");
  txt += "\n}";

  return txt;
};
</script>
.osu file <input type="file" id="chart" /><br />
Precision (unit amount of steps) <input type="number" id="precision" value="12" />
<br /><br /><br />
<a id="result" download="notes.chart" target="_blank">... Load something up there will you ...</a><br />
<textarea style="width:800px;height:500px" id="preview" placeholder="Result will appear below"></textarea>

<script>
  document.getElementById("chart").addEventListener('change', $event => {
    const fr = new FileReader();
    fr.addEventListener('loadend', () => {
      const converted = convert(fr.result);
      const blob = URL.createObjectURL(new Blob([converted], { type: 'application/chart' }));
      const link = document.getElementById('result');
      link.href = blob;
      link.innerHTML = 'Click to download';
      document.getElementById('preview').value = converted;
    });
    fr.readAsText($event.target.files[0]);
  });
  
  document.getElementById("precision").addEventListener('change', $event => {
    precision = Number($event.target.value) / 1000;
  });
</script>
</body>
</html>
